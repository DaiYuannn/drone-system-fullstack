# 无人机项目总方案与实施手册（NAZA + RC 注入 | 端到端）

本手册是项目单一可信来源（SSOT），覆盖从技术栈、系统架构、硬件实施、软件开发、系统联调到发布运维的全周期信息；随项目演进持续更新。已整合以下文档并统一为“大疆 NAZA 飞控 + RC 注入（SBUS/PPM）”主线：
- 《无人机系统开发指南-5e1adb03d1.md》
- 《项目流程与代码实现流程.md》
- 《优化建议与改进方案.md》

若与历史文档冲突，以本手册为准；PX4/MAVLink 路线可作为可选分支另行附录。

---

## 0. 目标与范围

- 目标：实现基于 NAZA 飞控的无人机系统，具备厘米级定位、低延迟视频、路径规划与基本自主飞行（通过 RC 注入控制），并支持多机协同与地面站可视化。
- 范围：硬件、机载程序（ROS2）、视频链路、服务器后端、网页前端、通信、CI/CD、测试与运维、安全与合规。
- 验收：单机悬停/航线误差、视频端到端延迟、通信稳定性、失联回退与模式切换安全、多机延迟与协同演示。

---

## 1. 技术栈与组件选型研究

### 1.1 定位与感知
- RTK-GPS：u-blox ZED-F9P（厘米级，室外）；
- 视觉：Intel RealSense D435i（双目+IMU）；
- IMU：BMI055；
- 定位融合：VIO/RTK 紧耦合（机载自用，不注入 NAZA）。

推荐：室外优先 RTK（Fix），室内/弱 GPS 切 VIO；提供冗余切换与延迟补偿。

### 1.2 飞控与控制策略
- 飞控：DJI NAZA（如 NAZA-M V2）；黑盒，不支持外部里程计/控制注入。
- 控制：机载控制律→RC 注入（SBUS/PPM）→NAZA（GPS Atti/Atti 模式）。
- RC 桥接：MCU（STM32/ESP32/Arduino）输出 SBUS/PPM；PC↔MCU 自定义二进制串口协议，100Hz 下发，CRC 校验，超时≤200ms 回中并切人工/NAZA Failsafe。

### 1.3 通信与服务
- 机载总线：ROS 2 Foxy + DDS；
- 地面通信：MQTT over WebSocket（EMQX）；
- 后端：FastAPI；
- 前端：Mapbox + Three.js；
- 视频：H.265 硬编（RK3588可选）、UDP+FEC、服务器解码转发（WS/MSE/LL-HLS）。

### 1.4 机体与动力
- 机架：F450 或定制；
- 动力：T-Motor MN2204-2300KV + XRotor 30A；
- 电池：3S 5000mAh；
- 图传：成都慧视 LLSM（或等效低延迟链路）。

---

## 2. 系统架构设计

### 2.1 硬件拓扑

无人机端：NAZA 飞控、RTK-GPS、双目相机/IMU、图传模块、机载电脑（Jetson/Nano/NUC）、RC 桥接 MCU；
地面端：服务器（Ubuntu）、EMQX、Web 前端。

### 2.2 数据流
- 感知/定位链路：相机/IMU/GNSS → 机载估计（融合）→ ROS2 话题；
- 规划控制链路：路径请求 → 规划轨迹（带时间戳/速度）→ 控制律（期望姿/速）→ RC 映射 → 串口 → MCU SBUS/PPM → NAZA；
- 视频链路：摄像头→H.265→无线→服务器解码转发→浏览器播放；
- 遥测与指令：机载/后端→MQTT/WS→前端；
- 安全/回退：失联/异常→回中/模式切换→NAZA Failsafe。

### 2.3 模块划分
- rc-bridge-mcu：MCU 固件（SBUS/PPM 生成、串口协议、超时回退）；
- onboard（ROS2）：estimation、planning、control_bridge、perception；
- backend：FastAPI + MQTT/WS + 视频转发；
- frontend：Three.js/Mapbox；
- video：编码/转发脚本；
- ops：Docker/CI/监控；
- docs：规范与手册。

---

## 3. 硬件实施指南

### 3.1 采购清单（建议）
- 飞控：DJI NAZA-M V2；
- RC 桥接：STM32/ESP32/Arduino + SBUS 变换电路；
- 机架/动力/电池：参考 F450 套件；
- 定位：ZED-F9P + 天线；
- 相机/IMU：D435i/BMI055；
- 图传：LLSM 或等效；
- 机载电脑：Jetson Nano 或 NUC；
- 杂项：PPS 线缆、示波器/逻辑分析仪（台架验证）。

### 3.2 组装与接线
- 电源布线：分电板焊接、线束固定、金属隔离；
- 传感器安装：减震、远离电磁干扰源；
- RC 桥接：MCU → SBUS/PPM → NAZA Rx；模式开关路径保留物理遥控优先；
- 图传与相机：短线连接、良好散热；
- 地线与屏蔽：相机/MCU/飞控共地，关键线束屏蔽。

### 3.3 校准与调试
- NAZA Assistant：加速度计/陀螺仪/磁力计/水平校准；模式开关配置；
- RTK：基准站/流动站接入，Fix 状态验证，室外基准点误差<3cm；
- RC 波形：示波器/逻辑分析仪验证 SBUS/PPM；
- 台架安全：拆桨或动力隔离；检查回中与失联回退。

---

## 4. 软件系统开发

### 4.1 机载 ROS2（estimation/planning/control/perception）
- estimation：VIO/RTK 融合，发布 /odom（nav_msgs/Odometry），提供延迟估计；
- planning：A*/RRT* 全局+局部重规划（<100ms），发布 /path（nav_msgs/Path）；
- control_bridge：订阅 /path，依据时间戳生成期望姿/速，RC 映射并下发串口；
- perception：YOLOv8（轻量）从 UDP/RTSP 取流，发布 /obstacles。

### 4.2 RC 桥接（Host ↔ MCU）
- 串口协议（二进制定长）：
  - 帧头0xA55A、seq、时间戳、12通道值（1100–1900us）、模式、CRC16/32；
  - 100Hz 下发，心跳 10Hz；超时>200ms→回中+模式切换；
- MCU：定时器+DMA 生成 SBUS/PPM；200Hz 帧生成，100Hz 更新；
- 安全：物理遥控优先权；失联→NAZA Failsafe；通道限幅与死区。

### 4.3 后端 FastAPI
- REST：POST /api/planning（start/end/obstacles→path）；
- WS：/ws（path.update、telemetry、alerts）；
- MQTT：drones/{id}/telemetry、drones/{id}/command（事件化：set_mode/set_path/abort）。

### 4.4 前端 Three.js/Mapbox
- 绘制路径点、速度约束；发送 path.update；
- 播放视频（MSE/WS）；
- 显示遥测、电量、链路质量与安全状态。

### 4.5 视频链路
- 编码：H.265 硬编；GOP=1、无 B 帧、CBR；
- 传输：UDP + FEC（10–20%）；
- 播放：Jitter Buffer 自适应 10–80ms；
- 测量：LED 时间牌+高速相机分解端到端时延。

---

## 5. 接口与消息契约

### 5.1 HTTP（FastAPI）
- POST /api/planning
  - Request: { start:[x,y,z], end:[x,y,z], obstacles:[[x,y,z,r], ...] }
  - Response: { path:[[x,y,z,t,spd], ...], cost?:number }

### 5.2 WebSocket 事件
- 上行：{ type:'path.update', points:[[lng,lat,alt,spd], ...] }
- 下行：{ type:'telemetry', pose:{x,y,z,yaw}, battery:%, link:{rssi,rate,latency}, alerts:[...] }

### 5.3 MQTT 主题
- drones/{id}/telemetry → { pose, vel, status, safety }
- drones/{id}/command → { type:'set_mode'|'set_path'|'abort', payload:{...} }

### 5.4 ROS 2 话题
- /odom nav_msgs/Odometry（融合位姿，含时间戳/延迟估计）；
- /path nav_msgs/Path（规划结果，时间戳/速度）；
- /obstacles custom_msgs/Obstacles；
- /rc_cmd custom_msgs/RcCmd：{ ch[12], mode, priority, deadline, source }。

### 5.5 RC 通道映射（NAZA 常规）
- CH1: Roll、CH2: Pitch、CH3: Throttle、CH4: Yaw、CH5: Mode（GPS Atti/Atti/Failsafe）。

---

## 6. 控制律与参数建议

- 更新频率：控制循环 100Hz（机载）；串口 100Hz；MCU 输出 200Hz 帧；
- 限幅：水平≤3m/s、垂直≤1.5m/s、yaw≤60°/s、倾角≤20°（初期）；
- 平滑：一阶滞后/梯形速度曲线；加速度≤2m/s²；
- 失联：200ms 无 Host 数据→回中+人工/NAZA Failsafe；
- 切换：RTK/VIO/GNSS 单点优先级切换带低通过渡；
- 保护：地理围栏、最大倾角/速度、遥控物理优先。

---

## 7. 系统集成与测试

### 7.1 联调流程
1) 硬件与RC桥接：示波器校验 SBUS/PPM，NAZA Assistant 看通道；
2) 机载闭环台架：拆桨/隔离动力，阶跃/缓变响应；
3) 端到端：前端路径→后端规划→机载控制→RC 注入→NAZA→姿态响应；
4) 外场：定点悬停（误差<0.5m）、矩形航线（误差<1m）；
5) 动态避障：检测→局部重规划→避障成功率与轨迹平滑性；
6) 多机：PTP<1ms，同步广播，任务分配与冲突避免。

### 7.2 性能指标
- 定位：RTK Fix 室外误差 ≤ 3cm；
- 控制：航线 RMSE < 1m；
- 视频：端到端延迟 ≤ 150ms；
- 通信：丢包 < 0.1%，多机延迟 < 50ms。

### 7.3 故障演练
- 失联/网络抖动、定位漂移、视频丢包；验证回退与提醒。

---

## 8. 里程碑与计划（S1–S5）

- S1 硬件采购与组装（2周）：装配、校准、RTK/图传验证；
- S2 RC 桥接与控制律（3周）：协议/MCU/Host、闭环台架、安全策略；
- S3 服务器与前端（4周）：FastAPI/MQTT/WS、路径编辑器、视频转发；
- S4 系统联调（2周）：端到端闭环、悬停/航线、动态避障；
- S5 多机测试（3周）：PTP、协同与演示报告。

---

## 9. 运维与工具链

- 开发：Windows + VSCode；PlatformIO（MCU）、Poetry/uv（Python）；
- 构建：Docker Compose；
- 监控：Prometheus + Grafana；
- 规范：pre-commit（black/isort/ruff/mypy）+ clang-format；
- 文档：本手册 + 协议/安全/视频配置专项文档。

---

## 10. CI/CD 与质量门禁

- Build：MCU 固件编译、Python 包/镜像构建；
- Lint/Typecheck：ruff/mypy、clang-format；
- Tests：
  - 单测：规划/协议/串口互操作；
  - 集成：Host 串口模拟→MCU 回环；端到端烟雾；
  - 性能：视频延迟、控制响应；
- 发布：容器镜像、版本标签、变更日志；
- 质量门禁：
  - Build: PASS；Lint/Type: PASS；Tests: PASS 方可合并。

---

## 11. 风险与回退

- RTK 不稳定：切 VIO/单点，限速与区域约束；
- 时间同步偏差：PPS+软件对齐，延迟估计补偿；
- 图传抖动：FEC+码率自适应+Jitter Buffer；
- 实时性不足：模型剪枝/张量加速，降分辨率，轨迹预采样；
- 安规合规：地理围栏、禁飞区自动锁定、遥控优先；
- 硬件冗余：RC 物理遥控覆盖优先权，失联快速回退。

---

## 12. 附录

### 12.1 目录结构（Monorepo）

repo/
- rc-bridge-mcu/
- onboard/
  - perception/
  - estimation/
  - planning/
  - control_bridge/
- backend/
- frontend/
- video/
- ops/
- docs/

### 12.2 参考与规范
- 开源：PX4、VINS-Fusion、three.js（架构参考）；
- 法规：注册/高度限制/禁飞区/隐私合规。

---

最后说明：本手册为活文档，请在变更后同步更新对应章节与版本记录。
