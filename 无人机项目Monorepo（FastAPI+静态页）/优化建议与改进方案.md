# 无人机项目计划与实现流程优化建议（多轮审阅版）

本文基于两份文档：
- 《无人机系统开发指南-5e1adb03d1.md》（原始技术方案）
- 《项目流程与代码实现流程.md》（已适配 NAZA + RC 注入）

采用多轮审阅，逐步提出并收敛可执行的改进方案。

---

## 第一轮优化（结构/安全/数据流/接口/工具链）

1) 飞控与控制架构
- 明确 NAZA 仅支持 RC 输入，不能注入外部里程计；将“外部定位影响飞控”的表述统一改为“机载侧自用定位用于产生RC控制量”。
- 新增“控制律层”与“安全层”划分：
  - 控制律层：期望速度/姿态->RC映射，含限幅/加速度/死区。
  - 安全层：失联、饱和、传感器异常、地理围栏、模式切换防抖。

2) RC 桥接与协议
- 建议采用二进制协议（定长+CRC16/32），100Hz 下发，心跳 10Hz；丢包重发与时钟漂移校正。
- MCU SBUS 输出建议200Hz帧生成但100Hz有效更新，减小延迟和抖动；失联超时≤200ms。
- CH 映射表与归一化：[-1,1]->[1100,1900]us，留出保护区：±0.9内。

3) 定位与时间同步
- 将 PPS/软件对齐策略放入机载估计模块的必选项；在 NAZA 方案下主要用于控制律的相位一致性与延迟补偿。
- 定位冗余：RTK→VIO→GNSS单点的优先级切换；每步切换的速度/加速度限幅过渡。

4) 视频链路与弱网策略
- 标准化低延迟配置：GOP=1、无B帧、CBR优先；弱网时降分辨率优先于降帧率。
- 播放端Jitter Buffer 自适应10–80ms；FEC 再发比例区间 10–20%。

5) 接口与消息契约
- 细化 /rc_cmd ROS2 消息：包含模式、优先级、截止时间戳（deadline）与来源（前端/自主）。
- MQTT 命令改为事件化：command.set_mode、command.set_path、command.abort，避免自由文本。

6) 工具链与环境
- Windows 侧建议 VSCode + PlatformIO（MCU）、Poetry/uv（Python 端）；显式锁定依赖。
- 引入 pre-commit（black/isort/ruff/mypy）与 clang-format（MCU）。

---

## 第二轮优化（可行性校验与细化参数）

A. RC 注入闭环可行性
- 可行：在 GPS Atti 模式下通过 RC 注入闭环，需小增益+慢速调参，优先速度外环、姿态内环。
- 参数建议：
  - RC 输出更新频率：100Hz；队列长度≤2，超时丢帧不堆积。
  - 速度限幅：水平≤3m/s、垂直≤1.5m/s、yaw≤60deg/s；倾角≤20°初期。
  - 平滑器：一阶滞后/梯形速度曲线，加速度≤2m/s^2。

B. 失联与回退
- Host→MCU 超时200ms进入“手动优先/NAZA Failsafe”路线；
- 后端/网络异常不影响近场控制：机载侧具备本地自主最小功能。

C. 规划与控制接口
- 规划输出轨迹段需携带时间戳与期望速度，使控制律按时刻跟踪。
- 提供轨迹采样器与速度剖面器（S曲线/梯形），便于在 NAZA 控制特性下平顺跟踪。

D. 视频端到端测量
- 定义“LED时间牌+高速相机”法为基线，记录延迟分解：编码、传输、解码、播放器缓存。

E. 多机协同
- NAZA 架构下多机仅限路径/速度层协同，避免姿态级耦合；每机独立RC桥与安全层。

---

## 第三轮优化（风险、测试、CI/可维护性与优先级）

优先级 P1（立即实施）
- RC 二进制协议与 Host/MCU 双端实现；心跳/超时/CRC；
- /rc_cmd 消息定义与串口桥节点；
- 控制律限幅与平滑器；失联回退与模式切换防抖；
- 视频链路低延迟参数固化；
- pre-commit 与CI工作流，引入仿真/台架自动回归（Host串口模拟）。

优先级 P2（两周内）
- 轨迹采样器与速度剖面器；
- 定位冗余切换策略与延迟补偿；
- Jitter Buffer 自适应调优；
- MQTT 事件化主题与权限模型（RBAC）。

优先级 P3（后续）
- MCU 双通道冗余（RC物理遥控与机载注入仲裁）；
- 视频 FEC 自适应；
- 多机任务分配器（改进匈牙利）。

测试与度量
- 台架：拆桨、惯性加载，控制步进与阶跃响应测量（上升/稳态误差/超调）。
- 外场：矩形航线误差统计（RMSE/最大偏差），路径动态重规划稳定性；
- 故障演练：失联、定位漂移、视频丢包、网络抖动，验证回退。

CI/CD 补充
- MCU：编译+单元测试+协议互操作测试（Host Python 模拟）；
- Python：lint/type/test，最小仿真（轨迹→RC映射）自动化；
- 后端/前端：契约测试（OpenAPI/WS事件），端到端烟雾测试。

---

## 最终改动清单（落地任务）

- docs
  - 补充《RC 串口协议规范.md》《安全与模式切换规范.md》《视频低延迟配置.md》。
- onboard/control_bridge
  - 新增 /rc_cmd 消息定义与串口发送器；加入限幅/平滑/失联回退。
- rc-bridge-mcu
  - 实现 SBUS/PPM 输出、协议解析、超时回退；加入回环测试模式。
- backend
  - MQTT 事件化命令与权限；
- frontend
  - 轨迹编辑器加入速度约束与时间戳；显示安全状态与链路质量。

如需，我可以继续生成上述新增文档与两个最小实现（Host 串口发送器、MCU SBUS/PPM 框架）的脚手架代码。
